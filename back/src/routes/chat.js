require('dotenv').config();
const express = require('express');
const { getDb } = require('../sqlite');
const { generateCourseStub } = require('../services/aiService');

const router = express.Router();

// In-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
// –ö–ª—é—á: sessionId, –∑–Ω–∞—á–µ–Ω–∏–µ: –º–∞—Å—Å–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π {role: 'user'|'assistant', content: string}
const chatHistory = new Map();

// –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º sessionId
function getSessionId(projectId, sessionId) {
  if (sessionId) return sessionId;
  if (projectId) return `project_${projectId}`;
  return 'temp_session';
}

// POST /api/chat - —á–∞—Ç —Å AI –¥–ª—è wizard
router.post('/', async (req, res) => {
  const { message, projectId, sessionId } = req.body;
  
  console.log('=== CHAT REQUEST ===');
  console.log('Message:', message);
  console.log('ProjectId:', projectId);
  console.log('SessionId:', sessionId);
  
  try {
    if (!message || !message.trim()) {
      return res.status(400).json({ error: 'Message is required' });
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID —Å–µ—Å—Å–∏–∏
    const currentSessionId = getSessionId(projectId, sessionId);
    console.log('Current sessionId:', currentSessionId);
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏
    if (!chatHistory.has(currentSessionId)) {
      chatHistory.set(currentSessionId, []);
      console.log('Created new session:', currentSessionId);
    }
    const history = chatHistory.get(currentSessionId);
    console.log('History length:', history.length);

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
    history.push({ role: 'user', content: message.trim() });
    console.log('Added user message to history');

    console.log('Importing geminiClient...');
    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç (ESM –º–æ–¥—É–ª—å)
    let callGeminiText, generateImage;
    try {
      const geminiModule = await import('../services/geminiClient.mjs');
      callGeminiText = geminiModule.callGeminiText;
      generateImage = geminiModule.generateImage || null; // –ú–æ–∂–µ—Ç –±—ã—Ç—å undefined
      if (!callGeminiText) {
        throw new Error('callGeminiText function not found in geminiClient module');
      }
      console.log('geminiClient imported successfully');
      console.log('generateImage available:', !!generateImage);
    } catch (importError) {
      console.error('Failed to import geminiClient:', importError);
      console.error('Import error stack:', importError.stack);
      throw new Error(`Failed to import Gemini client: ${importError.message}`);
    }
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 8 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤)
    const recentHistory = history.slice(-8);
    const historyContext = recentHistory.length > 0
      ? recentHistory.map(h => `${h.role === 'user' ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' : '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç'}: ${h.content}`).join('\n')
      : '';
    
    console.log('History context length:', historyContext.length);
    console.log('Recent messages:', recentHistory.length);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const imageKeywords = [
      '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', '–∫–∞—Ä—Ç–∏–Ω–∫–∞', '—Ä–∏—Å—É–Ω–æ–∫', '–∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è', '—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π', 
      '—Å–æ–∑–¥–∞–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', '–Ω–∞—Ä–∏—Å—É–π', '—Å–¥–µ–ª–∞–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', '–ø–æ–∫–∞–∂–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
      '—Å–æ–∑–¥–∞–π –∫–∞—Ä—Ç–∏–Ω–∫—É', '—Å–¥–µ–ª–∞–π –∫–∞—Ä—Ç–∏–Ω–∫—É', '–Ω–∞—Ä–∏—Å—É–π –∫–∞—Ä—Ç–∏–Ω–∫—É', '—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
      '–∏–∑–æ–±—Ä–∞–∑–∏', '–¥–∞–π –∫–∞—Ä—Ç–∏–Ω–∫—É', '–¥–∞–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', '–ø–æ–∫–∞–∂–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É', '–ø–æ–∫–∞–∂–∏ —Ä–∏—Å—É–Ω–æ–∫',
      '—Å–æ–∑–¥–∞–π –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—é', '—Å–¥–µ–ª–∞–π –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—é', '–Ω–∞—Ä–∏—Å—É–π –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—é', '–ø–æ–∫–∞–∂–∏ –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—é',
      '–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü', '–¥–∏–∞–≥—Ä–∞–º–º', '—Å—Ö–µ–º'
    ];
    const wantsImage = imageKeywords.some(keyword => message.toLowerCase().includes(keyword.toLowerCase()));
    console.log('Image generation requested:', wantsImage, 'Keywords found:', imageKeywords.filter(k => message.toLowerCase().includes(k.toLowerCase())));
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    let prompt = `–¢—ã SmartFlow –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ —ç–Ω—Ç—É–∑–∏–∞—Å—Ç–∏—á–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –∫—É—Ä—Å—ã.

${historyContext ? `–ò–°–¢–û–†–ò–Ø –†–ê–ó–ì–û–í–û–†–ê:\n${historyContext}\n\n` : ''}–¢–ï–ö–£–©–ï–ï –°–û–û–ë–©–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
${message}

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, —Ç–µ–ø–ª—ã–º –∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–º
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –≤—ã—Ä–∞–∂–µ–Ω–∏—è —ç–º–æ—Ü–∏–π (–Ω–æ —É–º–µ—Ä–µ–Ω–Ω–æ: ‚ú® üéØ üí° üìö üöÄ)
- –ü–æ–∫–∞–∑—ã–≤–∞–π —ç–Ω—Ç—É–∑–∏–∞–∑–º –∫ —Ç–µ–º–µ –∫—É—Ä—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ë—É–¥—å –∫—Ä–∞—Ç–∫–∏–º, –Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º ‚Äî –∏–∑–±–µ–≥–∞–π –∏–∑–ª–∏—à–Ω–µ–π –º–Ω–æ–≥–æ—Å–ª–æ–≤–Ω–æ—Å—Ç–∏
- –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω
- –ó–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –Ω–æ –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–í–ê–ñ–ù–û:
- –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –≤—ã—à–µ
- –ù–ï —Å–ø—Ä–∞—à–∏–≤–∞–π –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –£–ñ–ï –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª –≤ –∏—Å—Ç–æ—Ä–∏–∏
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —É–∫–∞–∑–∞–ª —Ç–µ–º—É, –∞—É–¥–∏—Ç–æ—Ä–∏—é, —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏–ª–∏ —Ü–µ–ª–∏ - –∫—Ä–∞—Ç–∫–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ –∏—Ö –∏ —Å–ø—Ä–æ—Å–∏ —Ç–æ–ª—å–∫–æ —Ç–æ, —á–µ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç
- –ï—Å–ª–∏ –≤—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–æ–±—Ä–∞–Ω–∞ (—Ç–µ–º–∞, –∞—É–¥–∏—Ç–æ—Ä–∏—è, —É—Ä–æ–≤–µ–Ω—å, —Ü–µ–ª–∏), –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å —Ñ—Ä–∞–∑–æ–π —Ç–∏–ø–∞ "–ì–æ—Ç–æ–≤ —Å–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å! –°–∫–∞–∂–∏—Ç–µ '—Å–æ–∑–¥–∞–π –∫—É—Ä—Å' –∏–ª–∏ '–¥–∞–≤–∞–π –Ω–∞—á–Ω–µ–º'"
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç —Å–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å, –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—É "–°–æ–∑–¥–∞—é –∫—É—Ä—Å..." –∏–ª–∏ "–ù–∞—á–∏–Ω–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é..." –≤ –Ω–∞—á–∞–ª–µ –æ—Ç–≤–µ—Ç–∞
- –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
${wantsImage ? '\n- –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç —Å–æ–∑–¥–∞—Ç—å/—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∫–∞—Ä—Ç–∏–Ω–∫—É, –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—é –∏–ª–∏ –¥–∏–∞–≥—Ä–∞–º–º—É - –ù–ï –≥–æ–≤–æ—Ä–∏ —á—Ç–æ —Ç—ã –Ω–µ –º–æ–∂–µ—à—å! –°–∏—Å—Ç–µ–º–∞ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —É–¥–∞—Å—Ç—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ —Ä–µ–≥–∏–æ–Ω–∞), —Å–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞—Å—Ç —Ç–µ–∫—Å—Ç–æ–≤—É—é –¥–∏–∞–≥—Ä–∞–º–º—É. –¢—ã –ø—Ä–æ—Å—Ç–æ –¥–∞–π –∫—Ä–∞—Ç–∫–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏, –∏ —Å–∏—Å—Ç–µ–º–∞ –¥–æ–±–∞–≤–∏—Ç –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ —Ç–µ–∫—Å—Ç–æ–≤—É—é –¥–∏–∞–≥—Ä–∞–º–º—É) –≤ –∫–æ–Ω–µ—Ü –æ—Ç–≤–µ—Ç–∞. –ù–ï –∑–∞–¥–∞–≤–∞–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ –∫—É—Ä—Å, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ - –ø—Ä–æ—Å—Ç–æ –æ–ø–∏—à–∏ —á—Ç–æ –±—É–¥–µ—Ç –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –∏ –¥–æ–∂–¥–∏—Å—å, –ø–æ–∫–∞ —Å–∏—Å—Ç–µ–º–∞ –¥–æ–±–∞–≤–∏—Ç –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é.' : ''}

–§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π Markdown –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è):
- –î–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏—Å–ø–æ–ª—å–∑—É–π –∑–∞–≥–æ–ª–æ–≤–∫–∏ ## –∏ ###
- –î–ª—è —Å–ø–∏—Å–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ (- –∏–ª–∏ *)
- –î–ª—è –≤–∞–∂–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π **–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç**
- –î–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π > —Ü–∏—Ç–∞—Ç—ã
- –î–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π \`–∫–æ–¥\`
- –†–∞–∑–±–∏–≤–∞–π –¥–ª–∏–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
- –î–µ–ª–∞–π –æ—Ç–≤–µ—Ç—ã –≤–∏–∑—É–∞–ª—å–Ω–æ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–º–∏ –∏ –ª–µ–≥–∫–æ —á–∏—Ç–∞–µ–º—ã–º–∏
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
- –î–æ–±–∞–≤–ª—è–π —ç–º–æ–¥–∑–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
${wantsImage ? '\n- –ï—Å–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—à—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç: ![–û–ø–∏—Å–∞–Ω–∏–µ](URL_–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)' : ''}

–ü–†–ò–ú–ï–† –•–û–†–û–®–ï–ì–û –û–¢–í–ï–¢–ê:
## ‚ú® –û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä!

**Python –¥–ª—è —à–∫–æ–ª—å–Ω–∏–∫–æ–≤** ‚Äî —ç—Ç–æ –∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–∞—è –∏–¥–µ—è! üéØ

–Ø –ø–æ–º–æ–≥—É –≤–∞–º —Å–æ–∑–¥–∞—Ç—å —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –∫—É—Ä—Å. –î–ª—è –Ω–∞—á–∞–ª–∞ –º–Ω–µ –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–µ—Ç–∞–ª–µ–π:

### üìã –ß—Ç–æ —É–∂–µ –∏–∑–≤–µ—Å—Ç–Ω–æ:
- **–¢–µ–º–∞:** Python
- **–ê—É–¥–∏—Ç–æ—Ä–∏—è:** –®–∫–æ–ª—å–Ω–∏–∫–∏

### üí° –ß—Ç–æ –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å:
- –ö–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏? (–Ω–∞—á–∞–ª—å–Ω—ã–π/—Å—Ä–µ–¥–Ω–∏–π)
- –ö–∞–∫–∏–µ —Ü–µ–ª–∏ –∫—É—Ä—Å–∞? (–æ—Å–Ω–æ–≤—ã –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è/–∏–≥—Ä—ã/–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è)

–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ, –∏ –º—ã —Å–æ–∑–¥–∞–¥–∏–º –∏–¥–µ–∞–ª—å–Ω—ã–π –∫—É—Ä—Å! üöÄ`;

    console.log('Prompt length:', prompt.length);
    console.log('Calling Gemini API with model:', process.env.GEMINI_MODEL || 'gemini-1.5-flash');
    
    let reply;
    try {
      reply = await callGeminiText(prompt, {
        model: process.env.GEMINI_MODEL || 'gemini-1.5-flash',
        maxOutputTokens: 2000,
        temperature: 0.7
      });
    } catch (callError) {
      console.error('Error calling Gemini API:', callError);
      console.error('Call error stack:', callError.stack);
      throw callError; // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ
    }
    
    if (!reply || typeof reply !== 'string') {
      throw new Error(`Invalid Gemini API response: ${JSON.stringify(reply)}`);
    }
    
    console.log('Gemini API response received, length:', reply.length);
    console.log('Response preview:', reply.substring(0, Math.min(100, reply.length)) + (reply.length > 100 ? '...' : ''));

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    let imageUrl = null;
    let imageDescription = ''; // –û–±—ä—è–≤–ª—è–µ–º –≤–Ω–µ try-catch –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –≤ catch –±–ª–æ–∫–µ
    if (wantsImage) {
      if (!generateImage) {
        console.warn('generateImage function not available, skipping image generation');
        reply += '\n\n‚ö†Ô∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.';
      } else {
        try {
          console.log('User requested image generation, attempting to generate...');
          // –ò–∑–≤–ª–µ–∫–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          // –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è
          // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –û–û–ü (—Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —ç—Ç–æ)
          if (message.toLowerCase().includes('–æ–æ–ø') || message.toLowerCase().includes('oop') || 
              message.toLowerCase().includes('–æ–±—ä–µ–∫—Ç') || message.toLowerCase().includes('–∫–ª–∞—Å—Å')) {
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–º—É –û–û–ü, —É–±–∏—Ä–∞—è –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
            let oopText = message
              .replace(/—Å–æ–∑–¥–∞–π|—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π|–Ω–∞—Ä–∏—Å—É–π|—Å–¥–µ–ª–∞–π|–ø–æ–∫–∞–∂–∏|–¥–ª—è –º–µ–Ω—è|–º–Ω–µ|–¥–∞–π|–∏–∑–æ–±—Ä–∞–∑–∏/gi, '')
              .replace(/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ|–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏–µ|–∫–∞—Ä—Ç–∏–Ω–∫—É|—Ä–∏—Å—É–Ω–æ–∫|–∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—é|–∫–∞—Ä—Ç–∏–Ω–∫–∞|–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è|–∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è|–∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏/gi, '')
              .replace(/–¥–∞–≤–∞–π|–¥–∞–≤–∞–π—Ç–µ|–º–æ–∂–µ—à—å|–º–æ–∂–µ—à—å –ª–∏|—Å–º–æ–∂–µ—à—å|—Å–º–æ–∂–µ—à—å –ª–∏|—á—Ç–æ–±—ã|—á—Ç–æ–±—ã –º–Ω–µ/gi, '')
              .replace(/–±—ã–ª–æ|–±—ã–ª–æ –ø–æ–Ω—è—Ç–Ω–æ|–ø–æ–Ω—è—Ç–Ω–æ|–∫–∞–∫ —ç—Ç–æ|–∫–∞–∫|–≤—ã–≥–ª—è–¥–∏—Ç|–Ω–∞ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏/gi, '')
              .trim();
            
            // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ "–≤ python" –∏–ª–∏ "python"
            oopText = oopText.replace(/\s*–≤\s+python\s*–≤\s+python/gi, ' –≤ Python');
            oopText = oopText.replace(/\s*–≤\s+python\s*$/gi, '');
            oopText = oopText.replace(/python\s+–≤\s+python/gi, 'Python');
            
            // –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å —á—Ç–æ-—Ç–æ –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–µ
            if (oopText.length > 3) {
              imageDescription = oopText;
            } else {
              imageDescription = '–û–û–ü –≤ Python: –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏';
            }
          } else {
            // –î–ª—è –¥—Ä—É–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            imageDescription = message
              // –£–±–∏—Ä–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ (–≤–∫–ª—é—á–∞—è –æ–ø–µ—á–∞—Ç–∫–∏)
              .replace(/—Å–æ–∑–¥–∞–π|—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π|–Ω–∞—Ä–∏—Å—É–π|—Å–¥–µ–ª–∞–π|–ø–æ–∫–∞–∂–∏|–¥–ª—è –º–µ–Ω—è|–º–Ω–µ|–¥–∞–π|–∏–∑–æ–±—Ä–∞–∑–∏/gi, '')
              .replace(/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ|–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏–µ|–∫–∞—Ä—Ç–∏–Ω–∫—É|—Ä–∏—Å—É–Ω–æ–∫|–∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—é|–∫–∞—Ä—Ç–∏–Ω–∫–∞|–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è|–∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è|–∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏/gi, '')
              .replace(/–¥–∞–≤–∞–π|–¥–∞–≤–∞–π—Ç–µ|–º–æ–∂–µ—à—å|–º–æ–∂–µ—à—å –ª–∏|—Å–º–æ–∂–µ—à—å|—Å–º–æ–∂–µ—à—å –ª–∏|—á—Ç–æ–±—ã|—á—Ç–æ–±—ã –º–Ω–µ/gi, '')
              .replace(/–±—ã–ª–æ|–±—ã–ª–æ –ø–æ–Ω—è—Ç–Ω–æ|–ø–æ–Ω—è—Ç–Ω–æ|–∫–∞–∫ —ç—Ç–æ|–∫–∞–∫|–≤—ã–≥–ª—è–¥–∏—Ç|–Ω–∞ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏|—Å|–≤/gi, '')
              .replace(/\s+/g, ' ')
              .trim();
          }
          
          // –ï—Å–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –∏–ª–∏ –ø—É—Å—Ç–æ–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
          if (!imageDescription || imageDescription.length < 5) {
            // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å —Ç–µ–º—É –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const recentUserMessages = history
              .filter(h => h.role === 'user')
              .slice(-5)
              .map(h => h.content)
              .join(' ');
            
            // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
            if (message.toLowerCase().includes('–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ') || recentUserMessages.toLowerCase().includes('–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ')) {
              imageDescription = '–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –≤ –æ–±—ä–µ–∫—Ç–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–∏';
            } else {
              // –ò—â–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —Ç–µ–º—ã –∫—É—Ä—Å–∞ –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏
              const topicMatch = recentUserMessages.match(/(?:–∫—É—Ä—Å|—Ç–µ–º–∞|–ø—Ä–æ|–æ–±|–∫–ª–∞—Å—Å|–æ–±—ä–µ–∫—Ç|python|–æ–æ–ø|–ø–æ–ª–∏–º–æ—Ä—Ñ–∏–∑–º|–∏–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏—è|–∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è)[\s:¬´¬ª"]*([^,\.\n]+?)(?:[¬´¬ª"]|$)/i);
              if (topicMatch && topicMatch[1]) {
                imageDescription = topicMatch[1].trim();
              } else {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ –æ—Å–Ω–æ–≤—É
                imageDescription = recentUserMessages.substring(0, 100).trim();
              }
            }
          }
          
          // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º (–ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å Imagen API)
          let promptForImage = imageDescription;
          
          // –ï—Å–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è
          if (/[–∞-—è—ë]/i.test(imageDescription)) {
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –∫–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
            const conceptMap = {
              '–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ': 'inheritance',
              '–∫–ª–∞—Å—Å': 'class',
              '–æ–±—ä–µ–∫—Ç': 'object',
              'python': 'python',
              '–æ–æ–ø': 'object-oriented programming',
              '–∏–µ—Ä–∞—Ä—Ö–∏—è': 'hierarchy',
              '–∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è': 'abstraction'
            };
            
            let englishPrompt = imageDescription;
            for (const [ru, en] of Object.entries(conceptMap)) {
              if (imageDescription.toLowerCase().includes(ru)) {
                englishPrompt = imageDescription.replace(new RegExp(ru, 'gi'), en);
                break;
              }
            }
            
            promptForImage = `Educational diagram illustration showing ${englishPrompt} in programming, clean and simple visual explanation, infographic style`;
          } else {
            promptForImage = `Educational diagram illustration showing ${imageDescription} in programming, clean and simple visual explanation, infographic style`;
          }
          
          console.log('Generating image with prompt:', promptForImage);
          console.log('Image description extracted:', imageDescription);
          
          try {
            imageUrl = await generateImage(promptForImage, {
              numberOfImages: 1,
              aspectRatio: '16:9' // –•–æ—Ä–æ—à–æ –¥–ª—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
            });
            
            console.log('Image generated successfully, URL length:', imageUrl?.length || 0);
            console.log('Image URL preview:', imageUrl?.substring(0, 100) || 'null');
          } catch (genError) {
            console.error('Error during image generation call:', genError);
            throw genError; // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–ª—å—à–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ –≤–Ω–µ—à–Ω–µ–º catch
          }
          
          // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –æ—Ç–≤–µ—Ç (–≤—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ —Ñ–∏–Ω–∞–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫—É—Ä—Å–∞, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å)
          if (imageUrl) {
            // –ï—Å–ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫—É—Ä—Å–∞, –≤—Å—Ç–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –Ω–∏–º
            if (reply.includes('‚úÖ –ö—É—Ä—Å —Å–æ–∑–¥–∞–Ω')) {
              const parts = reply.split('‚úÖ –ö—É—Ä—Å —Å–æ–∑–¥–∞–Ω');
              reply = parts[0] + `\n\n![–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è: ${imageDescription}](${imageUrl})\n\n` + '‚úÖ –ö—É—Ä—Å —Å–æ–∑–¥–∞–Ω' + parts[1];
            } else {
              reply += `\n\n![–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è: ${imageDescription}](${imageUrl})`;
            }
            console.log('Image URL added to reply');
          } else {
            console.warn('Image generation returned null or undefined URL');
          }
        } catch (imageError) {
          console.error('Failed to generate image:', imageError);
          console.error('Image error stack:', imageError.stack);
          // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, —Å–æ–∑–¥–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é –¥–∏–∞–≥—Ä–∞–º–º—É –≤–º–µ—Å—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
          const errorMsg = imageError.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
          
          // –ï—Å–ª–∏ imageDescription –Ω–µ –±—ã–ª–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          if (!imageDescription || imageDescription.length < 3) {
            imageDescription = message;
          }
          
          // –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤—É—é —Ç–µ–∫—Å—Ç–æ–≤—É—é –¥–∏–∞–≥—Ä–∞–º–º—É
          const descLower = imageDescription ? imageDescription.toLowerCase() : '';
          const msgLower = message.toLowerCase();
          
          // –î–∏–∞–≥—Ä–∞–º–º–∞ –¥–ª—è –û–û–ü –≤ Python (–æ–±—â–∞—è)
          if (descLower.includes('–æ–æ–ø') || descLower.includes('oop') || 
              descLower.includes('–æ–±—ä–µ–∫—Ç') || descLower.includes('–∫–ª–∞—Å—Å') ||
              msgLower.includes('–æ–æ–ø') || msgLower.includes('python')) {
            reply += '\n\n## üìä –í–∏–∑—É–∞–ª—å–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –û–û–ü –≤ Python:\n\n';
            reply += '```\n';
            reply += '‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n';
            reply += '‚îÇ              –û–°–ù–û–í–´ –û–û–ü –í PYTHON                ‚îÇ\n';
            reply += '‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n';
            reply += '                        ‚îÇ\n';
            reply += '        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n';
            reply += '        ‚îÇ                               ‚îÇ\n';
            reply += '   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n';
            reply += '   ‚îÇ  –ö–õ–ê–°–°  ‚îÇ                    ‚îÇ –û–ë–™–ï–ö–¢  ‚îÇ\n';
            reply += '   ‚îÇ (Class)  ‚îÇ ‚îÄ‚îÄ‚îÄ—Å–æ–∑–¥–∞–µ—Ç‚îÄ‚îÄ‚îÄ‚ñ∫     ‚îÇ(Instance)‚îÇ\n';
            reply += '   ‚îÇ          ‚îÇ                    ‚îÇ          ‚îÇ\n';
            reply += '   ‚îÇ –®–∞–±–ª–æ–Ω  ‚îÇ                    ‚îÇ –≠–∫–∑–µ–º–ø–ª—è—Ä‚îÇ\n';
            reply += '   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n';
            reply += '        ‚îÇ\n';
            reply += '        ‚îÇ –Ω–∞—Å–ª–µ–¥—É–µ—Ç\n';
            reply += '        ‚ñº\n';
            reply += '   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n';
            reply += '   ‚îÇ   –ù–ê–°–õ–ï–î–û–í–ê–ù–ò–ï           ‚îÇ\n';
            reply += '   ‚îÇ   (Inheritance)          ‚îÇ\n';
            reply += '   ‚îÇ                         ‚îÇ\n';
            reply += '   ‚îÇ  –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–ª–∞—Å—Å     ‚îÇ\n';
            reply += '   ‚îÇ      ‚îÇ                   ‚îÇ\n';
            reply += '   ‚îÇ      ‚ñº                   ‚îÇ\n';
            reply += '   ‚îÇ  –î–æ—á–µ—Ä–Ω–∏–π –∫–ª–∞—Å—Å         ‚îÇ\n';
            reply += '   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n';
            reply += '        ‚îÇ\n';
            reply += '        ‚îú‚îÄ‚îÄ‚ñ∫ –ò–ù–ö–ê–ü–°–£–õ–Ø–¶–ò–Ø (Encapsulation)\n';
            reply += '        ‚îÇ    –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏ –º–µ—Ç–æ–¥–æ–≤\n';
            reply += '        ‚îÇ\n';
            reply += '        ‚îú‚îÄ‚îÄ‚ñ∫ –ü–û–õ–ò–ú–û–†–§–ò–ó–ú (Polymorphism)\n';
            reply += '        ‚îÇ    –û–¥–∏–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –º–Ω–æ–≥–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π\n';
            reply += '        ‚îÇ\n';
            reply += '        ‚îî‚îÄ‚îÄ‚ñ∫ –ê–ë–°–¢–†–ê–ö–¶–ò–Ø (Abstraction)\n';
            reply += '             –°–∫—Ä—ã—Ç–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏\n';
            reply += '```\n\n';
            reply += '**–ü—Ä–∏–º–µ—Ä –Ω–∞ Python:**\n\n';
            reply += '```python\n';
            reply += '# –ö–ª–∞—Å—Å (Class) - —à–∞–±–ª–æ–Ω\n';
            reply += 'class Animal:\n';
            reply += '    def __init__(self, name):\n';
            reply += '        self.name = name  # –ê—Ç—Ä–∏–±—É—Ç\n';
            reply += '    \n';
            reply += '    def make_sound(self):  # –ú–µ—Ç–æ–¥\n';
            reply += '        pass\n';
            reply += '\n';
            reply += '# –ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ (Inheritance)\n';
            reply += 'class Dog(Animal):\n';
            reply += '    def make_sound(self):\n';
            reply += '        return "–ì–∞–≤!"\n';
            reply += '\n';
            reply += '# –û–±—ä–µ–∫—Ç (Object) - —ç–∫–∑–µ–º–ø–ª—è—Ä –∫–ª–∞—Å—Å–∞\n';
            reply += 'my_dog = Dog("–ë–æ–±–∏–∫")\n';
            reply += 'print(my_dog.make_sound())  # –ü–æ–ª–∏–º–æ—Ä—Ñ–∏–∑–º\n';
            reply += '```\n\n';
            reply += 'üí° **–ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏:**\n';
            reply += '- **–ö–ª–∞—Å—Å** ‚Äî —ç—Ç–æ —à–∞–±–ª–æ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤\n';
            reply += '- **–û–±—ä–µ–∫—Ç** ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –∫–ª–∞—Å—Å–∞\n';
            reply += '- **–ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ** ‚Äî –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞\n';
            reply += '- **–ò–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏—è** ‚Äî –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏ –º–µ—Ç–æ–¥–æ–≤\n';
            reply += '- **–ü–æ–ª–∏–º–æ—Ä—Ñ–∏–∑–º** ‚Äî –æ–¥–∏–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, —Ä–∞–∑–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏\n';
          }
          // –î–∏–∞–≥—Ä–∞–º–º–∞ –¥–ª—è –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è)
          else if (descLower.includes('–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ') ||
              descLower.includes('inheritance') ||
              msgLower.includes('–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ')) {
            reply += '\n\n## üìä –í–∏–∑—É–∞–ª—å–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è:\n\n';
            reply += '```\n';
            reply += '        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n';
            reply += '        ‚îÇ   –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–ª–∞—Å—Å    ‚îÇ\n';
            reply += '        ‚îÇ   (–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å)       ‚îÇ\n';
            reply += '        ‚îÇ                         ‚îÇ\n';
            reply += '        ‚îÇ  –ê—Ç—Ä–∏–±—É—Ç—ã:              ‚îÇ\n';
            reply += '        ‚îÇ  - –æ–±—â–∏–µ_–¥–∞–Ω–Ω—ã–µ         ‚îÇ\n';
            reply += '        ‚îÇ                         ‚îÇ\n';
            reply += '        ‚îÇ  –ú–µ—Ç–æ–¥—ã:                ‚îÇ\n';
            reply += '        ‚îÇ  - –æ–±—â–∏–π_–º–µ—Ç–æ–¥()        ‚îÇ\n';
            reply += '        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n';
            reply += '                    ‚îÇ –Ω–∞—Å–ª–µ–¥—É–µ—Ç\n';
            reply += '        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n';
            reply += '        ‚îÇ                           ‚îÇ\n';
            reply += '   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n';
            reply += '   ‚îÇ –î–æ—á–µ—Ä–Ω–∏–π  ‚îÇ            ‚îÇ  –î–æ—á–µ—Ä–Ω–∏–π    ‚îÇ\n';
            reply += '   ‚îÇ –∫–ª–∞—Å—Å 1   ‚îÇ            ‚îÇ  –∫–ª–∞—Å—Å 2     ‚îÇ\n';
            reply += '   ‚îÇ           ‚îÇ            ‚îÇ              ‚îÇ\n';
            reply += '   ‚îÇ –ù–∞—Å–ª–µ–¥—É–µ—Ç:‚îÇ            ‚îÇ  –ù–∞—Å–ª–µ–¥—É–µ—Ç:  ‚îÇ\n';
            reply += '   ‚îÇ - –¥–∞–Ω–Ω—ã–µ  ‚îÇ            ‚îÇ  - –¥–∞–Ω–Ω—ã–µ    ‚îÇ\n';
            reply += '   ‚îÇ - –º–µ—Ç–æ–¥—ã  ‚îÇ            ‚îÇ  - –º–µ—Ç–æ–¥—ã    ‚îÇ\n';
            reply += '   ‚îÇ           ‚îÇ            ‚îÇ              ‚îÇ\n';
            reply += '   ‚îÇ + —Å–≤–æ–∏:   ‚îÇ            ‚îÇ  + —Å–≤–æ–∏:     ‚îÇ\n';
            reply += '   ‚îÇ - –∞—Ç—Ä–∏–±—É—Ç ‚îÇ            ‚îÇ  - –∞—Ç—Ä–∏–±—É—Ç   ‚îÇ\n';
            reply += '   ‚îÇ - –º–µ—Ç–æ–¥() ‚îÇ            ‚îÇ  - –º–µ—Ç–æ–¥()   ‚îÇ\n';
            reply += '   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n';
            reply += '```\n\n';
            reply += '**–ü—Ä–∏–º–µ—Ä –Ω–∞ Python:**\n\n';
            reply += '```python\n';
            reply += 'class Vehicle:  # –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–ª–∞—Å—Å\n';
            reply += '    def __init__(self, speed, color):\n';
            reply += '        self.speed = speed\n';
            reply += '        self.color = color\n';
            reply += '    \n';
            reply += '    def move(self):\n';
            reply += '        print("–î–≤–∏–∂–µ—Ç—Å—è...")\n';
            reply += '\n';
            reply += 'class Car(Vehicle):  # –î–æ—á–µ—Ä–Ω–∏–π –∫–ª–∞—Å—Å\n';
            reply += '    def __init__(self, speed, color, doors):\n';
            reply += '        super().__init__(speed, color)  # –ù–∞—Å–ª–µ–¥—É–µ–º –æ—Ç Vehicle\n';
            reply += '        self.doors = doors  # –°–≤–æ–π –∞—Ç—Ä–∏–±—É—Ç\n';
            reply += '    \n';
            reply += '    def honk(self):  # –°–≤–æ–π –º–µ—Ç–æ–¥\n';
            reply += '        print("–ë–∏-–±–∏–ø!")\n';
            reply += '```\n\n';
            reply += 'üí° **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**\n';
            reply += '- `Car` –Ω–∞—Å–ª–µ–¥—É–µ—Ç –≤—Å–µ –æ—Ç `Vehicle` (speed, color, move())\n';
            reply += '- `Car` –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–≤–æ–∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ (doors, honk())\n';
            reply += '- –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `super()` –¥–ª—è –≤—ã–∑–æ–≤–∞ –º–µ—Ç–æ–¥–æ–≤ —Ä–æ–¥–∏—Ç–µ–ª—è\n';
          } else {
            // –î–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å–æ–∑–¥–∞–µ–º –æ–±—â—É—é —Ç–µ–∫—Å—Ç–æ–≤—É—é –¥–∏–∞–≥—Ä–∞–º–º—É
            reply += '\n\nüìä **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:**\n\n';
            reply += '```\n';
            reply += '‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n';
            reply += '‚îÇ   –ö–æ–Ω—Ü–µ–ø—Ü–∏—è/–¢–µ–º–∞    ‚îÇ\n';
            reply += '‚îÇ                     ‚îÇ\n';
            reply += '‚îÇ  –û—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã: ‚îÇ\n';
            reply += '‚îÇ  ‚Ä¢ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç 1      ‚îÇ\n';
            reply += '‚îÇ  ‚Ä¢ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç 2      ‚îÇ\n';
            reply += '‚îÇ  ‚Ä¢ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç 3      ‚îÇ\n';
            reply += '‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n';
            reply += '```\n\n';
          }
          
          if (errorMsg.includes('location is not supported') || errorMsg.includes('not available in your region')) {
            reply += '‚ö†Ô∏è *–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ Imagen API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –≤–∞—à–µ–º —Ä–µ–≥–∏–æ–Ω–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ VPN –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É Google Cloud.*\n';
          } else {
            reply += `‚ö†Ô∏è *–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API. –ü–æ–∫–∞–∑–∞–Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞.*\n`;
          }
        }
      }
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
    // –¢–æ–ª—å–∫–æ —è–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∫—É—Ä—Å–∞, –Ω–µ –ø—Ä–æ—Å—Ç–æ "—Å–æ–∑–¥–∞–π" (–º–æ–∂–µ—Ç –±—ã—Ç—å "—Å–æ–∑–¥–∞–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
    let createdProjectId = null;
    const createKeywords = [
      '—Å–æ–∑–¥–∞–π –∫—É—Ä—Å', '–Ω–∞—á–Ω–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é', '–¥–∞–≤–∞–π —Å–æ–∑–¥–∞–≤–∞–π', '—Å–æ–∑–¥–∞–≤–∞–π –∫—É—Ä—Å',
      '–Ω–∞—á–Ω–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å', '–Ω–∞—á–Ω–∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å', '–¥–∞–≤–∞–π –Ω–∞—á–Ω–µ–º',
      '—Å–æ–∑–¥–∞–π –ø—Ä–æ–µ–∫—Ç', '–Ω–∞—á–Ω–∏ –ø—Ä–æ–µ–∫—Ç', '–≥–æ—Ç–æ–≤ —Å–æ–∑–¥–∞—Ç—å', '–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å',
      '—Å–æ–∑–¥–∞–π –∫—É—Ä—Å', '–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∫—É—Ä—Å', '–Ω–∞—á–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∫—É—Ä—Å–∞'
    ];
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ —è–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∫—É—Ä—Å–∞ (–Ω–µ –ø—Ä–æ—Å—Ç–æ "—Å–æ–∑–¥–∞–π" –∏–ª–∏ "–≥–µ–Ω–µ—Ä–∏—Ä—É–π")
    const messageLower = message.toLowerCase();
    const wantsToCreate = createKeywords.some(keyword => 
      messageLower.includes(keyword.toLowerCase())
    ) && !messageLower.includes('–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ') && !messageLower.includes('–∫–∞—Ä—Ç–∏–Ω–∫') && !messageLower.includes('–∏–ª–ª—é—Å—Ç—Ä–∞—Ü');

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç —Å–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å –∏ –ø—Ä–æ–µ–∫—Ç –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω
    if (wantsToCreate && !projectId) {
      try {
        console.log('User wants to create course, extracting information from chat history...');
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫—É—Ä—Å–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
        const allUserMessages = history
          .filter(h => h.role === 'user')
          .map(h => h.content)
          .join(' ');
        
        // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å —Ç–µ–º—É, –∞—É–¥–∏—Ç–æ—Ä–∏—é, —Ü–µ–ª–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ (—É–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞)
        let topic = '–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∫—É—Ä—Å';
        const topicPatterns = [
          /(?:—Ç–µ–º–∞|–∫—É—Ä—Å|–ø—Ä–µ–¥–º–µ—Ç)[\s:¬´¬ª"]+([^,\.\n]+?)(?:[¬´¬ª"]|$)/i,
          /–∫—É—Ä—Å –ø–æ ([\w\s¬´¬ª"]+?)(?:[¬´¬ª"]|$)/i,
          /—Ö–æ—á—É —Å–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å (?:–ø–æ )?([\w\s¬´¬ª"]+?)(?:[¬´¬ª"]|$)/i,
          /—Å–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å (?:–ø–æ )?([\w\s¬´¬ª"]+?)(?:[¬´¬ª"]|$)/i,
          /¬´([^¬ª]+)¬ª/i, // –¢–µ–∫—Å—Ç –≤ –∫–∞–≤—ã—á–∫–∞—Ö
        ];
        for (const pattern of topicPatterns) {
          const match = allUserMessages.match(pattern);
          if (match && match[1]) {
            topic = match[1].trim().replace(/[¬´¬ª"]/g, '').substring(0, 100);
            if (topic.length > 10) break; // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —á—Ç–æ-—Ç–æ –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–µ
          }
        }
        
        let audience = '–°—Ç—É–¥–µ–Ω—Ç—ã';
        const audiencePatterns = [
          /(?:–∞—É–¥–∏—Ç–æ—Ä–∏—è|–¥–ª—è –∫–æ–≥–æ|—Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è)[\s:]+([^,\.\n]+?)(?:[\.\n]|$)/i,
          /(?:—Å—Ç—É–¥–µ–Ω—Ç—ã|—à–∫–æ–ª—å–Ω–∏–∫–∏|—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã|–Ω–∞—á–∏–Ω–∞—é—â–∏–µ)[\s\d]+(?:–∫—É—Ä—Å–∞|–≥–æ–¥–∞)?/i,
        ];
        for (const pattern of audiencePatterns) {
          const match = allUserMessages.match(pattern);
          if (match && match[1]) {
            audience = match[1].trim().substring(0, 50);
            break;
          }
        }
        // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –±–µ–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
        if (allUserMessages.match(/—Å—Ç—É–¥–µ–Ω—Ç—ã/i)) audience = '–°—Ç—É–¥–µ–Ω—Ç—ã';
        else if (allUserMessages.match(/—à–∫–æ–ª—å–Ω–∏–∫–∏/i)) audience = '–®–∫–æ–ª—å–Ω–∏–∫–∏';
        else if (allUserMessages.match(/—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã/i)) audience = '–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã';
        
        let goal = '–ò–∑—É—á–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞';
        const goalMatch = allUserMessages.match(/(?:—Ü–µ–ª—å|—Ü–µ–ª–∏|–Ω–∞—É—á–∏—Ç—å—Å—è|–Ω–∞—É—á–∏—Ç—å|–¥–æ–ª–∂–Ω—ã)[\s:]+([^,\.\n]+?)(?:[\.\n]|$)/i);
        if (goalMatch && goalMatch[1]) {
          goal = goalMatch[1].trim().substring(0, 100);
        }
        
        let level = '–°—Ä–µ–¥–Ω–∏–π';
        const levelMatch = allUserMessages.match(/(?:—É—Ä–æ–≤–µ–Ω—å|—Å–ª–æ–∂–Ω–æ—Å—Ç—å)[\s:]+([^,\.\n]+?)(?:[\.\n]|$)/i);
        if (levelMatch && levelMatch[1]) {
          level = levelMatch[1].trim().substring(0, 50);
        }
        // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è –±–µ–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
        if (allUserMessages.match(/(?:–Ω–∞—á–∞–ª—å–Ω—ã–π|–ª–µ–≥–∫–∏–π|–ø—Ä–æ—Å—Ç–æ–π)/i)) level = '–ù–∞—á–∞–ª—å–Ω—ã–π';
        else if (allUserMessages.match(/(?:—Å—Ä–µ–¥–Ω–∏–π|–±–∞–∑–æ–≤—ã–π)/i)) level = '–°—Ä–µ–¥–Ω–∏–π';
        else if (allUserMessages.match(/(?:–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π|—Å–ª–æ–∂–Ω—ã–π|–≤—ã—Å–æ–∫–∏–π)/i)) level = '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤–∏–∑—É–∞–ª–æ–≤, —Ç–µ—Å—Ç–æ–≤, –≤–∏–¥–µ–æ
        const hasVisuals = /–≤–∏–∑—É–∞–ª|–∫–∞—Ä—Ç–∏–Ω–∫|–∏–∑–æ–±—Ä–∞–∂–µ–Ω|–∏–ª–ª—é—Å—Ç—Ä–∞—Ü/i.test(allUserMessages);
        const hasTests = /—Ç–µ—Å—Ç|–ø—Ä–æ–≤–µ—Ä–∫|–∑–∞–¥–∞–Ω–∏/i.test(allUserMessages);
        const hasVideos = /–≤–∏–¥–µ–æ|—Å—Ü–µ–Ω–∞—Ä–∏/i.test(allUserMessages);
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º metaPrompt –∏–∑ –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏
        const metaPrompt = `–°–æ–∑–¥–∞–π –ø–æ–ª–Ω—ã–π –æ–Ω–ª–∞–π–Ω-–∫—É—Ä—Å –Ω–∞ —Ç–µ–º—É: "${topic}"
–ê—É–¥–∏—Ç–æ—Ä–∏—è: ${audience}
–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: ${level}
–¶–µ–ª—å: ${goal}
${hasVisuals ? '–í–∫–ª—é—á–∏ –≤–∏–∑—É–∞–ª—ã –∏ –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏' : ''}
${hasTests ? '–í–∫–ª—é—á–∏ —Ç–µ—Å—Ç—ã –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è' : ''}
${hasVideos ? '–í–∫–ª—é—á–∏ –≤–∏–¥–µ–æ-—Å—Ü–µ–Ω–∞—Ä–∏–∏' : ''}

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ–ª–∂–Ω–∞ –≤–∫–ª—é—á–∞—Ç—å –º–æ–¥—É–ª–∏, —É—Ä–æ–∫–∏, –ø—Ä–∏–º–µ—Ä—ã –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è.`;

        console.log('Creating project with:', { topic, audience, goal, level });
        
        // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–µ–∫—Ç
        const db = getDb();
        const metaData = {
          topic,
          audience,
          goal,
          level,
          visuals: hasVisuals,
          tests: hasTests,
          videos: hasVideos,
          metaPrompt
        };
        
        const stmt = db.prepare('INSERT INTO projects (title, description, meta) VALUES (?, ?, ?)');
        const info = stmt.run(`–ö—É—Ä—Å: ${topic}`, `–ö—É—Ä—Å –¥–ª—è ${audience}`, JSON.stringify(metaData));
        createdProjectId = info.lastInsertRowid;
        
        console.log('Project created with ID:', createdProjectId);
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –≤ —Ñ–æ–Ω–µ (–Ω–µ –∂–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è)
        generateCourseStub(metaData)
          .then(generated => {
            const insertModule = db.prepare('INSERT INTO modules (project_id, title, position) VALUES (?, ?, ?)');
            const insertLesson = db.prepare('INSERT INTO lessons (module_id, title, content, position) VALUES (?, ?, ?, ?)');
            
            const tx = db.transaction((generated) => {
              generated.modules.forEach((m, mi) => {
                const info = insertModule.run(createdProjectId, m.title, mi);
                const mid = info.lastInsertRowid;
                (m.lessons || []).forEach((l, li) => {
                  insertLesson.run(mid, l.title, l.content || '', li);
                });
              });
            });
            
            tx(generated);
            db.prepare('UPDATE projects SET status = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?')
              .run('generated', createdProjectId);
            console.log('Course generation completed for project:', createdProjectId);
          })
          .catch(err => {
            console.error('Course generation error:', err);
            db.prepare('UPDATE projects SET status = ? WHERE id = ?').run('error', createdProjectId);
          });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç, –¥–æ–±–∞–≤–ª—è—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–∑–¥–∞–Ω–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ
        reply += `\n\n‚úÖ **–ö—É—Ä—Å —Å–æ–∑–¥–∞–Ω –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞—á–∞—Ç–∞!**\n\n–Ø —Å–æ–∑–¥–∞–ª –ø—Ä–æ–µ–∫—Ç –∏ –Ω–∞—á–∞–ª –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫—É—Ä—Å–∞. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –æ–±—â–∞—Ç—å—Å—è —Å–æ –º–Ω–æ–π –≤ —á–∞—Ç–µ, –∏ —è –ø–æ–º–æ–≥—É –≤–∞–º –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –∫—É—Ä—Å. –ö–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã, –≤—ã —Å–º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é.`;
        
      } catch (createError) {
        console.error('Error creating project:', createError);
        reply += '\n\n‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –≤—Ä—É—á–Ω—É—é.';
      }
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é
    history.push({ role: 'assistant', content: reply.trim() });
    console.log('Added assistant reply to history');
    console.log('Total history length:', history.length);

    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ (—Ö—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å–æ–æ–±—â–µ–Ω–∏–π)
    if (history.length > 20) {
      history.splice(0, history.length - 20);
      console.log('Trimmed history to 20 messages');
    }

    console.log('=== CHAT REQUEST COMPLETE ===\n');

    res.json({ 
      reply,
      sessionId: currentSessionId,
      imageUrl: imageUrl || undefined,
      projectId: createdProjectId || projectId || undefined // –í–æ–∑–≤—Ä–∞—â–∞–µ–º ID —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
    });
  } catch (error) {
    console.error('=== CHAT ERROR ===');
    console.error('Error name:', error.name);
    console.error('Error message:', error.message);
    console.error('Error stack:', error.stack);
    if (error.cause) {
      console.error('Error cause:', error.cause);
    }
    console.error('==================\n');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—à–∏–±–∫—É —Ä–µ–≥–∏–æ–Ω–∞
    const isRegionError = error.message && error.message.includes('location is not supported');
    
    // –ë–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–µ
    const errorDetails = {
      error: isRegionError ? 'Region not supported' : 'Failed to get AI response',
      message: error.message,
      name: error.name
    };
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –æ—à–∏–±–∫–∏ —Ä–µ–≥–∏–æ–Ω–∞
    if (isRegionError) {
      errorDetails.hint = 'Gemini API is not available in your region. Use VPN or contact support.';
      errorDetails.helpUrl = 'https://ai.google.dev/available_regions';
    }
    
    // –í —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    if (process.env.NODE_ENV === 'development') {
      errorDetails.stack = error.stack;
      if (error.cause) {
        errorDetails.cause = error.cause;
      }
    }
    
    res.status(500).json(errorDetails);
  }
});

// –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–µ—Å—Å–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
router.delete('/:sessionId', (req, res) => {
  const { sessionId } = req.params;
  chatHistory.delete(sessionId);
  console.log('Cleared history for session:', sessionId);
  res.json({ success: true });
});

module.exports = router;

